var fst=new Object;fst.action=new Object;fst.ajax=function(action,options){var url="?"+action;action=action.replace(/\W.*$/,"");options=jQuery.extend(new Object,fst.ajax._options._default,fst.ajax._options[action]===undefined?new Object:fst.ajax._options[action],options===undefined?new Object:options);if(options.preprocess(options)===false)return false;if(options.confirm!==false){if(fst.dialog&&fst.dialog.confirm){fst.dialog.confirm(options.confirm,{ok:options.confirm_ok,cancel:options.confirm_cancel,callback:function(confirmed){if(confirmed){options.preprocess_confirmed(options);options.preprocess=function(){};options.confirm=false;fst.ajax(action,options)}else{options.preprocess_denied(options);options.postprocess()}}});return false}else{if(confirm(options.confirm))options.preprocess_confirmed(options);else{options.preprocess_denied(options);options.postprocess();return false}}}jQuery.ajax({url:url,data:options.data,type:"POST"}).done(function(response){options.callback(response);options.postprocess()});return false};fst.ajax._options=new Array;fst.ajax._options._default={callback:function(response){},confirm:false,confirm_ok:"OK",confirm_cancel:"Cancel",data:new Object,preprocess:function(options){},preprocess_confirmed:function(options){},preprocess_denied:function(options){},postprocess:function(){}};fst.ajax.options=function(action,options){fst.ajax._options[action]=options};fst.ajax.options_default=function(options){jQuery.extend(fst.ajax._options._default,options)};fst.content=function(name,options){options=jQuery.extend({data:new Object,preprocess:function(){},postprocess:function(){}},options===undefined?new Object:options);options.data._content=name;options.preprocess.apply(fst.content.element(name),[options]);jQuery.ajax({url:"?_content",data:options.data,type:"POST"}).done(function(response){fst.content.element(name).html(response);options.postprocess.apply(fst.content.element(name));jQuery.each(fst.content._ready,function(idx,fcn){fcn(fst.content.element(name))})})};fst.content.element=function(name){return jQuery('[data-fst="content'+(name===undefined?"":"-"+name)+'"]')};fst.content.ready=function(fcn){fst.content._ready.push(fcn)};fst.content._ready=new Array;fst.form=new Object;fst.form._options=new Array;fst.form.cancel=function(){fst.redirect.back()};fst.form.data=function(form){var data=new Object;jQuery(form).find("select[multiple]").each(function(){data[jQuery(this).prop("name")]=jQuery(this).val()});jQuery(form).find('div[data-fst="form-control-multiple"]').each(function(){var name=jQuery(this).attr("data-fst-name");data[name]=new Array;$(this).find('input[data-fst="form-control-multiple-option"]:checked').each(function(){data[name].push($(this).val())})});jQuery.each(jQuery(form).serializeArray(),function(_,kv){if(!data[kv.name])data[kv.name]=kv.value});return data};fst.form.datepicker=function(ctl){if(fst._init._datepicker_installed===undefined)fst._init._datepicker_installed=jQuery().datepicker!==undefined;if(!fst._init._datepicker_installed)return;if(ctl===undefined){fst.form.datepicker($('[data-fst="form-control-date"]'));return}jQuery(ctl).filter('[data-fst="form-control-date"]').each(function(){jQuery(this).attr("type","text");jQuery(this).blur();if(jQuery(this).val())jQuery(this).val(fst.dt_mdy(jQuery(this).val()));var options={};if(jQuery(this).attr("max"))options.maxDate=fst.dt_mdy(jQuery(this).attr("max"));if(jQuery(this).attr("min"))options.minDate=fst.dt_mdy(jQuery(this).attr("min"));jQuery(this).datepicker(options);jQuery(this).data("fst","form-control-datepicker")})};fst.form.error=function(form,fld,msg,clear){var err=jQuery("#"+jQuery(form).attr("id")+"_"+fld).parents('[data-fst="form-controls-row"]').siblings('[data-fst="form-error"]');err.html(clear?"<div>"+msg+"</div>":err.html()+"<div>"+msg+"</div>")};fst.form.errors=function(form,errors){var form_id=jQuery(form).attr("id");jQuery.each(errors,function(fld,msg){fst.form.error(form,fld,msg)})};fst.form.errors.clear=function(form){jQuery(form).find('[data-fst="form-error"]').html("")};fst.form.name=function(form){var action=jQuery(form).attr("action");return jQuery(form).attr("data-fst")=="form"&&/^\?_form=\w+$/.test(action)?action.substring(7):false};fst.form.options=function(name,options){var ctlname=jQuery.type(name)=="string"&&/^\w+$/.test(name)?name:fst.form.name(name);fst.form._options[ctlname]=options};fst.init=function(options){jQuery.extend(fst._init,options)};fst._init={datepicker:false,timeselect:false};fst.redirect=function(uri){window.location=fst.uri(uri)};fst.redirect.home=function(){fst.redirect("")};fst.redirect.back=function(n){n?window.history.go(-n):window.history.back()};fst.reload=function(){window.location.reload()};fst.replace=function(uri){window.location.replace(fst.uri(uri))};fst.replace.home=function(){fst.replace("")};fst.form.timeselect=function(ctl){if(ctl===undefined){fst.form.timeselect($('[data-fst="form-control-time"]'));return}jQuery(ctl).filter('[data-fst="form-control-time"]').each(function(){var sel=jQuery("<select></select>");var time=jQuery(this);sel.attr("id",time.attr("id"));sel.attr("name",time.attr("name"));sel.data("fst","form-control-timeselect");var min=time.attr("min")?time.attr("min"):"00:00";var max=time.attr("max")?time.attr("max"):"23:59";var step=time.attr("step")?time.attr("step"):300;var val=time.val();var tm=new Date("01/01/2001 "+min);var tm_end=new Date("01/01/2001 "+max);while(tm<=tm_end){var ts=tm.toTimeString().substring(0,5);var hr=tm.getHours();var mn=tm.getMinutes();var ap=hr<12?"am":"pm";if(hr===0)hr=12;if(hr>12)hr-=12;if(mn<10)mn="0"+mn;var ts2=hr+":"+mn+"&nbsp;"+ap;sel.append(val==ts?'<option value="'+ts+'" selected="selected">'+ts2+"</option>":'<option value="'+ts+'">'+ts2+"</option>");tm=new Date(tm.getTime()+step*1e3)}if(val&&!sel.find("[selected]").length){tm=new Date("01/01/2001 "+val);var ts=tm.toTimeString().substring(0,5);var hr=tm.getHours();var mn=tm.getMinutes();var ap=hr<12?"am":"pm";if(hr===0)hr=12;if(hr>12)hr-=12;if(mn<10)mn="0"+mn;var ts2=hr+":"+mn+"&nbsp;"+ap;sel.prepend('<option value="'+ts+'" selected="selected">'+ts2+"</option>")}sel.prepend(val==""?'<option value="" selected="selected">--:-- --</option>':'<option value="">--:-- --</option>');time.replaceWith(sel)})};fst.uri=function(uri){var absuri=/^(\w+:|\/|\?)/;return absuri.test(uri)?uri:(_approot?_approot:"/")+uri};fst.dt_mdy=function(dt){var re=/^(\d{4})-(\d\d)-(\d\d)$/;return dt.match(re)?dt.replace(/^(\d{4})-(\d\d)-(\d\d)$/,"$2/$3/$1"):dt};jQuery(document).on("click",'a[href^="?"]',null,function(event){var action=jQuery(this).attr("href").substring(1).replace(/\W.*$/,"");if(fst.action[action]!==false){event.preventDefault();fst.action[action]?fst.action[action].apply(jQuery(this)):fst.ajax(jQuery(this).attr("href").substring(1),{data:jQuery(this).data()})}});jQuery(document).on("click",'input[type="button"][data-fst-href], button[data-fst-href]',null,function(event){var href=jQuery(this).attr("data-fst-href");if(href.match(/^\?/)){var action=href.substring(1).replace(/\W.*$/,"");if(fst.action[action]!==false){fst.action[action]?fst.action[action].apply(jQuery(this)):fst.ajax(href.substring(1),{data:jQuery(this).data()})}}else window.location=href});jQuery(document).on("submit",'form[data-fst="form"][action^="?_form="]',null,function(event){event.preventDefault();var form=jQuery(this);var name=fst.form.name(form);options=jQuery.extend({callback:function(response){},callback_fail:function(response){fst.form.errors(this,response.errors)},data:fst.form.data(form),preprocess:function(options){},postprocess:function(){}},fst.form._options[name]?fst.form._options[name]:new Object);fst.form.errors.clear(form);if(options.preprocess.apply(form,[options])===false)return;var ajax_options={url:jQuery(form).attr("action"),type:"POST"};var file_controls=jQuery(form).find('input[data-fst|="form-control-file"]');if(file_controls.length){ajax_options.data=new FormData;ajax_options.processData=false;ajax_options.contentType=false;jQuery.each(options.data,function(key,value){ajax_options.data.append(key,value)});file_controls.each(function(){var files=jQuery(this).prop("files");var name=jQuery(this).attr("name");for(var i=0;i<files.length;i++)ajax_options.data.append(name,files[i],files[i].name)});if(options.progress)ajax_options.xhr=function(){var xhr=new window.XMLHttpRequest;xhr.upload.addEventListener("progress",function(event){if(event.lengthComputable)options.progress(Math.round(100*event.loaded/event.total),event.loaded,event.total);else options.progress(false,0,0)});return xhr}}else ajax_options.data=options.data;jQuery.ajax(ajax_options).done(function(response){response.valid?options.callback.apply(form,[response]):options.callback_fail.apply(form,[response]);options.postprocess.apply(form)})});jQuery(document).on("click",'form[data-fst="form"] button[data-fst="form-cancel"]',null,function(event){var frm=jQuery(this).closest("form");var name=fst.form.name(frm);var cancel=fst.form._options[name]&&fst.form._options[name].cancel?fst.form._options[name].cancel:fst.form.cancel;cancel.apply(frm)});jQuery(document).ready(function(){if(fst._init.datepicker=="legacy"){var tmp;tmp=document.createElement("input");tmp.setAttribute("type","date");fst._init.datepicker=tmp.type!="date"}if(fst._init.timeselect=="legacy"){var tmp;tmp=document.createElement("input");tmp.setAttribute("type","time");fst._init.timeselect=tmp.type!="time"}if(fst._init.datepicker)fst.form.datepicker();if(fst._init.timeselect)fst.form.timeselect()});
